# Web IDE PDF - å¼€å‘è€…æŒ‡å—

[![Python](https://img.shields.io/badge/Python-3.8%2B-blue.svg)](https://python.org)
[![FastAPI](https://img.shields.io/badge/FastAPI-Latest-009688.svg)](https://fastapi.tiangolo.com)
[![SQLAlchemy](https://img.shields.io/badge/SQLAlchemy-Latest-red.svg)](https://sqlalchemy.org)
[![Code Style](https://img.shields.io/badge/Code%20Style-PEP%208-brightgreen.svg)](https://pep8.org)

> ğŸ› ï¸ **é¢å‘å¼€å‘è€…å’Œè´¡çŒ®è€…çš„æŠ€æœ¯æ–‡æ¡£**

## ğŸ“– å¼€å‘è€…æ¦‚è¿°

æœ¬æ–‡æ¡£é¢å‘å¸Œæœ›ç†è§£ã€ä¿®æ”¹æˆ–æ‰©å±•Web IDE PDFé¡¹ç›®çš„å¼€å‘è€…ã€‚é¡¹ç›®é‡‡ç”¨ç°ä»£PythonæŠ€æœ¯æ ˆï¼ŒåŸºäºFastAPIæ¡†æ¶æ„å»ºï¼Œæä¾›AIé©±åŠ¨çš„PDFå¤„ç†åŠŸèƒ½ã€‚

### ğŸ¯ å¼€å‘ç›®æ ‡

- **æ¨¡å—åŒ–è®¾è®¡** - æ¸…æ™°çš„ä»£ç ç»„ç»‡å’Œç»„ä»¶åˆ†ç¦»
- **å¯æ‰©å±•æ€§** - æ”¯æŒæ–°åŠŸèƒ½å’ŒæœåŠ¡çš„è½»æ¾é›†æˆ
- **é«˜æ€§èƒ½** - ä¼˜åŒ–çš„æ•°æ®åº“æŸ¥è¯¢å’ŒAPIå“åº”
- **æµ‹è¯•è¦†ç›–** - å…¨é¢çš„è‡ªåŠ¨åŒ–æµ‹è¯•å’Œè´¨é‡ä¿è¯
- **æ–‡æ¡£å®Œå–„** - è¯¦ç»†çš„ä»£ç æ³¨é‡Šå’ŒAPIæ–‡æ¡£

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
Web IDE PDF ç³»ç»Ÿæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Swagger UI    â”‚    â”‚   Custom UI     â”‚                   â”‚
â”‚  â”‚  (API Testing)  â”‚    â”‚  (Future Web)   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Application Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 FastAPI Application                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚    AI     â”‚ â”‚   Auth    â”‚ â”‚CodeBlocks â”‚ â”‚   Collab  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Router   â”‚ â”‚  Router   â”‚ â”‚  Router   â”‚ â”‚  Router   â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  PDF Parser  â”‚ â”‚ AI Assistant â”‚ â”‚  File Utils  â”‚           â”‚
â”‚  â”‚   (PyPDF2)   â”‚ â”‚ (DeepSeek)   â”‚ â”‚ (Utils)      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Data Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   SQLite DB     â”‚    â”‚   File Storage  â”‚                   â”‚
â”‚  â”‚  (SQLAlchemy)   â”‚    â”‚   (Local/AWS)   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
my_project/
â”œâ”€â”€ ğŸ“ app/                          # åº”ç”¨ç¨‹åºæ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py                  # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ main.py                      # FastAPIåº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ database.py                  # æ•°æ®åº“é…ç½®å’Œè¿æ¥
â”‚   â”œâ”€â”€ models.py                    # SQLAlchemyæ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ schemas.py                   # Pydanticæ•°æ®æ¨¡å¼
â”‚   â”œâ”€â”€ auth.py                      # ç”¨æˆ·è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“ routers/                  # APIè·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py              
â”‚   â”‚   â”œâ”€â”€ ai_assistant.py          # AIåŠ©æ‰‹è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ codeblock.py             # ä»£ç å—ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ collab.py                # åä½œåŠŸèƒ½è·¯ç”±
â”‚   â”‚   â””â”€â”€ ppt.py                   # PPTå¤„ç†è·¯ç”±
â”‚   â””â”€â”€ ğŸ“ utils/                    # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ code_runner.py           # ä»£ç æ‰§è¡Œå·¥å…·
â”œâ”€â”€ ğŸ“ tests/                        # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ conftest.py                  # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ test_main.py                 # ä¸»åº”ç”¨æµ‹è¯•
â”‚   â”œâ”€â”€ test_ai_assistant.py         # AIåŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_models.py               # æ•°æ®æ¨¡å‹æµ‹è¯•
â”‚   â””â”€â”€ test_integration.py          # é›†æˆæµ‹è¯•
â”œâ”€â”€ ğŸ“ docs/                         # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ APIæ–‡æ¡£.md                   # APIæ¥å£æ–‡æ¡£
â”‚   â””â”€â”€ å¼€å‘è€…æŒ‡å—.md                # æœ¬æ–‡æ¡£
â”œâ”€â”€ ğŸ“ dist/                         # æ‰“åŒ…è¾“å‡º
â”œâ”€â”€ requirements.txt                 # ä¾èµ–æ–‡ä»¶
â”œâ”€â”€ pytest.ini                      # æµ‹è¯•é…ç½®
â””â”€â”€ README.md                        # é¡¹ç›®è¯´æ˜
```

## ğŸ’» å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. å‰ç½®è¦æ±‚

```bash
# Pythonç‰ˆæœ¬æ£€æŸ¥
python --version  # éœ€è¦3.8+

# Gitç‰ˆæœ¬æ§åˆ¶
git --version

# å¯é€‰ï¼šè™šæ‹Ÿç¯å¢ƒå·¥å…·
pip install virtualenv
```

### 2. é¡¹ç›®å…‹éš†å’Œè®¾ç½®

```bash
# 1. å…‹éš†é¡¹ç›®
git clone [é¡¹ç›®ä»“åº“åœ°å€]
cd my_project

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ–
venv\Scripts\activate     # Windows

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. å®‰è£…å¼€å‘å·¥å…·
pip install -r requirements-test.txt
```

### 3. ç¯å¢ƒé…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# AIæœåŠ¡é…ç½®
DEEPSEEK_API_KEY=your_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///./app.db

# åº”ç”¨é…ç½®
DEBUG=True
LOG_LEVEL=DEBUG
SECRET_KEY=your_secret_key_here

# æ–‡ä»¶ä¸Šä¼ é…ç½®
MAX_FILE_SIZE=10485760  # 10MB
UPLOAD_DIR=./uploads
```

### 4. æ•°æ®åº“åˆå§‹åŒ–

```bash
# è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨
python -c "
from app.database import engine
from app.models import Base
Base.metadata.create_all(bind=engine)
print('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')
"
```

### 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¼€å‘æ¨¡å¼å¯åŠ¨
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# è®¿é—®åº”ç”¨
# http://127.0.0.1:8000      - ä¸»æœåŠ¡
# http://127.0.0.1:8000/docs - APIæ–‡æ¡£
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. FastAPIåº”ç”¨ä¸»å…¥å£ (app/main.py)

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .routers import ai_assistant, codeblock, collab
from .auth import router as auth_router
from . import models, database

# åˆ›å»ºåº”ç”¨å®ä¾‹
app = FastAPI(
    title="Web IDE Backend",
    description="åŸºäº FastAPI çš„ç½‘é¡µ IDE åç«¯ç³»ç»Ÿ"
)

# é…ç½®CORSä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒéœ€è¦é™åˆ¶
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# åˆå§‹åŒ–æ•°æ®åº“
models.Base.metadata.create_all(bind=database.engine)

# æ³¨å†Œè·¯ç”±
app.include_router(auth_router)
app.include_router(ai_assistant.router)
app.include_router(codeblock.router, prefix="/codeblocks")
app.include_router(collab.router)
```

### 2. æ•°æ®åº“æ¨¡å‹ (app/models.py)

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, Boolean, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

Base = declarative_base()

class AIRequestRecord(Base):
    """AIè¯·æ±‚è®°å½•è¡¨"""
    __tablename__ = "ai_request_records"
    
    id = Column(Integer, primary_key=True, index=True)
    question = Column(Text, nullable=False)
    answer = Column(Text, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

class User(Base):
    """ç”¨æˆ·è¡¨"""
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True)
    hashed_password = Column(String(100), nullable=False)
    role = Column(String(20), default="student")
    
    # å…³è”å…³ç³»
    ppts = relationship("PPT", back_populates="owner")

class PPT(Base):
    """PPTæ–‡ä»¶è¡¨"""
    __tablename__ = "ppts"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False)
    file_path = Column(String(500), nullable=False)
    uploaded_by = Column(Integer, ForeignKey("users.id"))
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # å…³è”å…³ç³»
    owner = relationship("User", back_populates="ppts")
    codeblocks = relationship("CodeBlock", back_populates="ppt")
```

### 3. AIåŠ©æ‰‹è·¯ç”± (app/routers/ai_assistant.py)

```python
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.orm import Session
from ..database import get_db
from ..models import AIRequestRecord
from ..schemas import QuestionRequest, QuestionResponse
import PyPDF2
import io

router = APIRouter(prefix="/ai", tags=["AIåŠ©æ‰‹"])

@router.post("/ask", response_model=QuestionResponse)
async def ask_question(
    question: QuestionRequest, 
    db: Session = Depends(get_db)
):
    """å¤„ç†æ–‡æœ¬é—®ç­”"""
    if not question.question.strip():
        raise HTTPException(status_code=400, detail="é—®é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º")
    
    # è°ƒç”¨AIæœåŠ¡
    ai_response = await call_ai_service(question.question)
    
    # ä¿å­˜è®°å½•åˆ°æ•°æ®åº“
    record = AIRequestRecord(
        question=question.question,
        answer=ai_response
    )
    db.add(record)
    db.commit()
    
    return QuestionResponse(answer=ai_response)

@router.post("/ask_with_pdf")
async def ask_with_pdf(
    question: str = Form(...),
    pdf_file: UploadFile = File(...),
    db: Session = Depends(get_db)
):
    """å¤„ç†PDFæ–‡ä»¶é—®ç­”"""
    # éªŒè¯æ–‡ä»¶æ ¼å¼
    if pdf_file.content_type != "application/pdf":
        raise HTTPException(status_code=400, detail="ä»…æ”¯æŒPDFæ ¼å¼æ–‡ä»¶")
    
    # æå–PDFæ–‡æœ¬
    pdf_text = extract_pdf_text(pdf_file)
    
    # æ„å»ºå¸¦ä¸Šä¸‹æ–‡çš„é—®é¢˜
    context_question = f"åŸºäºä»¥ä¸‹PDFå†…å®¹å›ç­”é—®é¢˜ï¼š\n\n{pdf_text}\n\né—®é¢˜ï¼š{question}"
    
    # è°ƒç”¨AIæœåŠ¡
    answer = await call_ai_service(context_question)
    
    return {
        "answer": answer,
        "pdf_summary": f"å·²åˆ†æPDFæ–‡æ¡£ï¼Œå…±æå–{len(pdf_text)}ä¸ªå­—ç¬¦"
    }

def extract_pdf_text(pdf_file: UploadFile) -> str:
    """æå–PDFæ–‡æœ¬å†…å®¹"""
    try:
        pdf_content = pdf_file.file.read()
        pdf_reader = PyPDF2.PdfReader(io.BytesIO(pdf_content))
        
        text = ""
        for page in pdf_reader.pages:
            text += page.extract_text()
        
        return text.strip()
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"PDFè§£æå¤±è´¥: {str(e)}")
```

### 4. æ•°æ®æ¨¡å¼å®šä¹‰ (app/schemas.py)

```python
from pydantic import BaseModel, EmailStr
from typing import Optional
from datetime import datetime

class QuestionRequest(BaseModel):
    """é—®é¢˜è¯·æ±‚æ¨¡å‹"""
    question: str

class QuestionResponse(BaseModel):
    """é—®é¢˜å“åº”æ¨¡å‹"""
    answer: str

class UserCreate(BaseModel):
    """ç”¨æˆ·åˆ›å»ºæ¨¡å‹"""
    username: str
    email: EmailStr
    password: str
    role: Optional[str] = "student"

class UserResponse(BaseModel):
    """ç”¨æˆ·å“åº”æ¨¡å‹"""
    id: int
    username: str
    email: str
    role: str
    
    class Config:
        from_attributes = True

class AIRecordResponse(BaseModel):
    """AIè®°å½•å“åº”æ¨¡å‹"""
    id: int
    question: str
    answer: str
    created_at: datetime
    
    class Config:
        from_attributes = True
```

## ğŸ”§ å¼€å‘å·¥å…·å’Œæµç¨‹

### 1. ä»£ç è´¨é‡å·¥å…·

```bash
# ä»£ç æ ¼å¼åŒ–
black app/ tests/

# ä»£ç æ£€æŸ¥
flake8 app/ tests/

# ç±»å‹æ£€æŸ¥
mypy app/

# å¯¼å…¥æ’åº
isort app/ tests/
```

### 2. æµ‹è¯•è¿è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_ai_assistant.py

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html

# è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
pytest -v -s
```

### 3. æ•°æ®åº“è¿ç§»

```bash
# å¦‚æœä½¿ç”¨Alembicè¿›è¡Œæ•°æ®åº“è¿ç§»
pip install alembic

# åˆå§‹åŒ–è¿ç§»ç¯å¢ƒ
alembic init alembic

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "æè¿°å˜æ›´"

# åº”ç”¨è¿ç§»
alembic upgrade head
```

### 4. APIæ–‡æ¡£ç”Ÿæˆ

```bash
# å¯åŠ¨æœåŠ¡åè®¿é—®
# http://127.0.0.1:8000/docs     - Swagger UI
# http://127.0.0.1:8000/redoc    - ReDoc
# http://127.0.0.1:8000/openapi.json - OpenAPIè§„èŒƒ
```

## ğŸš€ åŠŸèƒ½æ‰©å±•æŒ‡å—

### 1. æ·»åŠ æ–°çš„AIåŠŸèƒ½

```python
# 1. åœ¨ app/routers/ai_assistant.py ä¸­æ·»åŠ æ–°è·¯ç”±
@router.post("/new_ai_feature")
async def new_ai_feature(
    request: NewFeatureRequest,
    db: Session = Depends(get_db)
):
    """æ–°AIåŠŸèƒ½çš„æè¿°"""
    # å®ç°åŠŸèƒ½é€»è¾‘
    result = await process_new_feature(request)
    return {"result": result}

# 2. åœ¨ app/schemas.py ä¸­å®šä¹‰æ•°æ®æ¨¡å‹
class NewFeatureRequest(BaseModel):
    input_data: str
    options: Optional[dict] = {}

# 3. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
def test_new_ai_feature(client):
    response = client.post("/ai/new_ai_feature", json={
        "input_data": "æµ‹è¯•æ•°æ®"
    })
    assert response.status_code == 200
```

### 2. æ·»åŠ æ–°çš„æ•°æ®åº“è¡¨

```python
# 1. åœ¨ app/models.py ä¸­å®šä¹‰æ–°æ¨¡å‹
class NewModel(Base):
    __tablename__ = "new_table"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    data = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)

# 2. åœ¨ app/schemas.py ä¸­å®šä¹‰å¯¹åº”çš„Pydanticæ¨¡å‹
class NewModelCreate(BaseModel):
    name: str
    data: Optional[str] = None

class NewModelResponse(BaseModel):
    id: int
    name: str
    data: Optional[str]
    created_at: datetime
    
    class Config:
        from_attributes = True

# 3. åˆ›å»ºç›¸åº”çš„CRUDæ“ä½œ
def create_new_model(db: Session, model_data: NewModelCreate):
    db_model = NewModel(**model_data.dict())
    db.add(db_model)
    db.commit()
    db.refresh(db_model)
    return db_model
```

### 3. é›†æˆæ–°çš„å¤–éƒ¨æœåŠ¡

```python
# 1. åˆ›å»ºæœåŠ¡å®¢æˆ·ç«¯ç±»
class ExternalServiceClient:
    def __init__(self, api_key: str, base_url: str):
        self.api_key = api_key
        self.base_url = base_url
        self.session = requests.Session()
        self.session.headers.update({
            "Authorization": f"Bearer {api_key}"
        })
    
    async def call_service(self, data: dict):
        """è°ƒç”¨å¤–éƒ¨æœåŠ¡"""
        response = self.session.post(
            f"{self.base_url}/api/endpoint",
            json=data
        )
        return response.json()

# 2. åœ¨é…ç½®ä¸­æ·»åŠ æœåŠ¡é…ç½®
EXTERNAL_SERVICE_API_KEY = os.getenv("EXTERNAL_SERVICE_API_KEY")
EXTERNAL_SERVICE_URL = os.getenv("EXTERNAL_SERVICE_URL")

# 3. åˆ›å»ºä¾èµ–æ³¨å…¥
def get_external_service() -> ExternalServiceClient:
    return ExternalServiceClient(
        api_key=EXTERNAL_SERVICE_API_KEY,
        base_url=EXTERNAL_SERVICE_URL
    )
```

## ğŸ› è°ƒè¯•å’Œæ•…éšœæ’é™¤

### 1. æ—¥å¿—é…ç½®

```python
import logging
from fastapi import FastAPI

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("app.log"),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ—¥å¿—
@router.post("/ai/ask")
async def ask_question(question: QuestionRequest):
    logger.info(f"æ”¶åˆ°é—®é¢˜: {question.question}")
    try:
        # å¤„ç†é€»è¾‘
        result = await process_question(question.question)
        logger.info(f"é—®é¢˜å¤„ç†æˆåŠŸ")
        return result
    except Exception as e:
        logger.error(f"é—®é¢˜å¤„ç†å¤±è´¥: {str(e)}")
        raise
```

### 2. å¸¸è§é—®é¢˜è§£å†³

**æ•°æ®åº“è¿æ¥é—®é¢˜**:
```python
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
from app.database import engine
try:
    with engine.connect() as conn:
        result = conn.execute("SELECT 1")
        print("æ•°æ®åº“è¿æ¥æ­£å¸¸")
except Exception as e:
    print(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
```

**AIæœåŠ¡è°ƒç”¨é—®é¢˜**:
```python
# æ·»åŠ é‡è¯•æœºåˆ¶
import asyncio
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=4, max=10)
)
async def call_ai_service_with_retry(question: str):
    """å¸¦é‡è¯•çš„AIæœåŠ¡è°ƒç”¨"""
    try:
        return await call_ai_service(question)
    except Exception as e:
        logger.warning(f"AIæœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•: {e}")
        raise
```

### 3. æ€§èƒ½ç›‘æ§

```python
import time
from functools import wraps

def monitor_performance(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = await func(*args, **kwargs)
            end_time = time.time()
            logger.info(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {end_time - start_time:.2f}ç§’")
            return result
        except Exception as e:
            end_time = time.time()
            logger.error(f"{func.__name__} æ‰§è¡Œå¤±è´¥ï¼Œè€—æ—¶: {end_time - start_time:.2f}ç§’")
            raise
    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@monitor_performance
async def ask_question(question: QuestionRequest):
    # å‡½æ•°å®ç°
    pass
```

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. è¾“å…¥éªŒè¯

```python
from pydantic import validator
import re

class UserCreate(BaseModel):
    username: str
    password: str
    
    @validator('username')
    def validate_username(cls, v):
        if not re.match(r'^[a-zA-Z0-9_]{3,20}$', v):
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20å­—ç¬¦')
        return v
    
    @validator('password')
    def validate_password(cls, v):
        if len(v) < 8:
            raise ValueError('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½')
        if not re.search(r'[A-Za-z]', v) or not re.search(r'\d', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—')
        return v
```

### 2. SQLæ³¨å…¥é˜²æŠ¤

```python
# ä½¿ç”¨SQLAlchemy ORMï¼Œé¿å…åŸç”ŸSQL
from sqlalchemy.orm import Session

def get_user_by_id(db: Session, user_id: int):
    # å®‰å…¨çš„æŸ¥è¯¢æ–¹å¼
    return db.query(User).filter(User.id == user_id).first()

# é¿å…ä½¿ç”¨åŸç”ŸSQLæ‹¼æ¥
# é”™è¯¯ç¤ºä¾‹ï¼š
# query = f"SELECT * FROM users WHERE id = {user_id}"  # å±é™©ï¼

# æ­£ç¡®ç¤ºä¾‹ï¼š
# db.execute(text("SELECT * FROM users WHERE id = :user_id"), {"user_id": user_id})
```

### 3. æ–‡ä»¶ä¸Šä¼ å®‰å…¨

```python
import magic
from pathlib import Path

ALLOWED_EXTENSIONS = {'.pdf', '.doc', '.docx'}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB

def validate_file(file: UploadFile):
    """éªŒè¯ä¸Šä¼ æ–‡ä»¶"""
    # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
    file_ext = Path(file.filename).suffix.lower()
    if file_ext not in ALLOWED_EXTENSIONS:
        raise HTTPException(400, "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    file.file.seek(0, 2)  # ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾
    file_size = file.file.tell()
    file.file.seek(0)     # é‡ç½®åˆ°æ–‡ä»¶å¼€å¤´
    
    if file_size > MAX_FILE_SIZE:
        raise HTTPException(400, "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
    
    # æ£€æŸ¥æ–‡ä»¶MIMEç±»å‹
    file_content = file.file.read(1024)  # è¯»å–å‰1KB
    file.file.seek(0)
    
    mime_type = magic.from_buffer(file_content, mime=True)
    if mime_type != "application/pdf":
        raise HTTPException(400, "æ–‡ä»¶å†…å®¹ä¸æ‰©å±•åä¸åŒ¹é…")
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```python
from sqlalchemy.orm import joinedload, selectinload

# ä½¿ç”¨eager loadingé¿å…N+1æŸ¥è¯¢é—®é¢˜
def get_user_with_ppts(db: Session, user_id: int):
    return db.query(User)\
        .options(selectinload(User.ppts))\
        .filter(User.id == user_id)\
        .first()

# ä½¿ç”¨ç´¢å¼•
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, index=True)  # æ·»åŠ ç´¢å¼•
    email = Column(String(100), unique=True, index=True)    # æ·»åŠ ç´¢å¼•
```

### 2. ç¼“å­˜ç­–ç•¥

```python
from functools import lru_cache
import redis

# å†…å­˜ç¼“å­˜
@lru_cache(maxsize=100)
def get_ai_response_cache(question: str):
    """ç¼“å­˜AIå“åº”"""
    return call_ai_service(question)

# Redisç¼“å­˜
redis_client = redis.Redis(host='localhost', port=6379, db=0)

async def get_cached_response(question: str):
    """ä»Redisè·å–ç¼“å­˜å“åº”"""
    cache_key = f"ai_response:{hash(question)}"
    cached = redis_client.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    response = await call_ai_service(question)
    redis_client.setex(
        cache_key, 
        3600,  # 1å°æ—¶è¿‡æœŸ
        json.dumps(response)
    )
    return response
```

### 3. å¼‚æ­¥å¤„ç†

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

# ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†CPUå¯†é›†å‹ä»»åŠ¡
executor = ThreadPoolExecutor(max_workers=4)

async def process_pdf_async(pdf_file: UploadFile):
    """å¼‚æ­¥å¤„ç†PDFæ–‡ä»¶"""
    loop = asyncio.get_event_loop()
    
    # åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡ŒCPUå¯†é›†å‹ä»»åŠ¡
    text = await loop.run_in_executor(
        executor,
        extract_pdf_text_sync,
        pdf_file
    )
    return text

def extract_pdf_text_sync(pdf_file: UploadFile) -> str:
    """åŒæ­¥PDFæ–‡æœ¬æå–ï¼ˆCPUå¯†é›†å‹ï¼‰"""
    # PDFå¤„ç†é€»è¾‘
    pass
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# app/config.py
import os
from pydantic import BaseSettings

class Settings(BaseSettings):
    # åŸºç¡€é…ç½®
    app_name: str = "Web IDE PDF"
    debug: bool = False
    
    # æ•°æ®åº“é…ç½®
    database_url: str = os.getenv("DATABASE_URL", "sqlite:///./app.db")
    
    # AIæœåŠ¡é…ç½®
    deepseek_api_key: str = os.getenv("DEEPSEEK_API_KEY")
    deepseek_base_url: str = os.getenv("DEEPSEEK_BASE_URL")
    
    # å®‰å…¨é…ç½®
    secret_key: str = os.getenv("SECRET_KEY")
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 2. Dockeréƒ¨ç½²

```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/webide
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    depends_on:
      - db
    volumes:
      - ./uploads:/app/uploads

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=webide
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 3. ç›‘æ§å’Œæ—¥å¿—

```python
# ç»“æ„åŒ–æ—¥å¿—
import structlog

logger = structlog.get_logger()

@router.post("/ai/ask")
async def ask_question(question: QuestionRequest):
    logger.info(
        "å¤„ç†é—®é¢˜è¯·æ±‚",
        question_length=len(question.question),
        user_id=current_user.id if current_user else None
    )
    
    try:
        result = await process_question(question)
        logger.info(
            "é—®é¢˜å¤„ç†æˆåŠŸ",
            response_length=len(result.answer)
        )
        return result
    except Exception as e:
        logger.error(
            "é—®é¢˜å¤„ç†å¤±è´¥",
            error=str(e),
            error_type=type(e).__name__
        )
        raise
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### 1. å¼€å‘æµç¨‹

1. **Forké¡¹ç›®** - åˆ›å»ºé¡¹ç›®çš„ä¸ªäººå‰¯æœ¬
2. **åˆ›å»ºåˆ†æ”¯** - `git checkout -b feature/æ–°åŠŸèƒ½`
3. **ç¼–å†™ä»£ç ** - éµå¾ªä»£ç è§„èŒƒå’Œæœ€ä½³å®è·µ
4. **ç¼–å†™æµ‹è¯•** - ç¡®ä¿æ–°åŠŸèƒ½æœ‰ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹
5. **è¿è¡Œæµ‹è¯•** - `pytest` ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
6. **æäº¤ä»£ç ** - `git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"`
7. **æ¨é€åˆ†æ”¯** - `git push origin feature/æ–°åŠŸèƒ½`
8. **åˆ›å»ºPR** - è¯¦ç»†æè¿°å˜æ›´å†…å®¹

### 2. ä»£ç è§„èŒƒ

```python
# éµå¾ªPEP 8è§„èŒƒ
# ä½¿ç”¨ç±»å‹æ³¨è§£
def process_question(question: str) -> str:
    """å¤„ç†ç”¨æˆ·é—®é¢˜
    
    Args:
        question: ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
        
    Returns:
        AIç”Ÿæˆçš„å›ç­”
        
    Raises:
        ValueError: å½“é—®é¢˜ä¸ºç©ºæ—¶
    """
    if not question.strip():
        raise ValueError("é—®é¢˜ä¸èƒ½ä¸ºç©º")
    
    return ai_service.generate_answer(question)

# ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å
user_query = request.get("question")
ai_response = process_question(user_query)
```

### 3. æ–‡æ¡£æ›´æ–°

- æ–°åŠŸèƒ½éœ€è¦æ›´æ–°APIæ–‡æ¡£
- é‡è¦å˜æ›´éœ€è¦æ›´æ–°å¼€å‘è€…æŒ‡å—
- å…¬å¼€æ¥å£å˜æ›´éœ€è¦æ›´æ–°README

---

ğŸ› ï¸ **è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¼€å‘è€…æŒ‡å—ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹å’Œæ‰©å±•Web IDE PDFé¡¹ç›®ï¼** 